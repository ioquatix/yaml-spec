#!/usr/bin/env perl

use v5.18;

use XXX;  # XXX

my ($front, $markdown);
my ($YYYY, $MM, $DD);

sub main {
  read_files(@_);
  set_vars();
  fmt_dates();
  fmt_toc();
  fmt_index();

#   my @parts;
#   for my $section (parse_sections()) {
#     my ($key) = keys %$section;
#     $method = "fmt_$key";
#     $_ = $section->{$key};
#     push @parts, main->$method;
#   }
# 
#   print "$front";
#   print join "\n", @parts;

  print "$front$markdown\n";
}

sub parse_sections {
  my @s;

  $_ = $markdown;
  while ($_) {
    s/\A(#{1,4} .*\n)\n+//
      and push @s, {hx => $1} and next;
    s/\A(\*\*.*\*\*\n)\n+//
      and push @s, {hx => $1} and next;
    s/\A((?:\* .*\n)+(?:\{:\.\S+\}\n)?)\n+//
      and push @s, {ul => $1} and next;
    s/\A((?:(?:\*\*|\[[\w\"\*]|[\w\"\(]).*\n)+)\n+//
      and push @s, {p => $1} and next;
    s/\A----\n\n+//
      and push @s, {hr => 1} and next;
    s/\A\[%toc%\]\n\n+//
      and push @s, {toc => 1} and next;
    s/\A\[%index%\]\n//
      and push @s, {index => 1} and next;
    s/\A((?:> .*\n)+)\n+//
      and push @s, {in => $1} and next;
    s/\A((?s:```.+?\n```\n))\n+//
      and push @s, {pre => $1} and next;
    s/\A(!\[.*\.png\)\n)\s+//
      and push @s, {img => $1} and next;
    s/\A(\* .*\n(?:  \S.*\n)+)\n+//
      and push @s, {ul => $1} and next;
    s/\A(\`\w.*\n)\n+//
      and push @s, {p => $1} and next;
    s/\A((?:\| .*)+)\n+//
      and push @s, {tbl => $1} and next;
    s/\A((?:\* .*\n)(?:  .*\n|\n(?=  ))+)\n+//
      and push @s, {ul => $1} and next;


    s/((?:.*\n){10})(?s:.*)/$1/;
    WWW \@s;
    die "------\n$_<<<";
  }

  return @s;
}

sub read_files {
  my ($front_file, $markdown_file) = @_;
  $front = read_file($front_file);
  $markdown = read_file($markdown_file);
}

sub read_file {
  my ($file) = @_;
  open my $fh, '<', $file;
  local $/;
  <$fh>;
}

sub set_vars {
  my ($d,$m,$y);
  ($_,$_,$_,$d,$m,$y) = localtime;
  $YYYY = 1900 + $y;
  $MM = sprintf "%02d", $m + 1;
  $DD = sprintf "%02d", $d;
}

sub fmt_dates {
  $markdown =~ s/YYYY/$YYYY/g;
  $markdown =~ s/MM/$MM/g;
  $markdown =~ s/DD/$DD/g;
}

sub fmt_toc {
  $markdown =~ s/^\[%toc%\]/**Contents**\n\n* TOC\n\{:toc\}/m;
}

sub fmt_index {
  $markdown =~ s/^(\[%index%\])$/# Index\n\n$1/m;
}

main @ARGV;
