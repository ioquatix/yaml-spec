<!DOCTYPE html>
<html lang="en-US">

<head>
<meta http-equiv="Content-Type"
      content="text/html; charset=UTF-8" />

<title>Review YAML Spec Conversion</title>

<!--meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"-->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
      integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"s
      crossorigin="anonymous" />
<script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/coffee-script/1.7.1/coffee-script.min.js"></script>
<style>
.iframe {
  overflow: hidden;
  /* 16:9 aspect ratio */
  padding-top: 56.25%;
  position: relative;
}

.iframe iframe {
   border: 0;
   height: 100%;
   left: 0;
   position: absolute;
   top: 0;
   width: 100%;
}
</style>

</head>

<body>

<div class="container-fluid">
  <div class="row">
    <div class="iframe col-lg-4">
      <iframe src="markdown.html"></iframe>
    </div>
    <div class="iframe col-lg-4">
      <iframe src="spec.html"></iframe>
    </div>
    <div class="iframe col-lg-4">
      <iframe src="spec-12.html"></iframe>
    </div>
  </div>
</div>

<script type="text/coffeescript">
window.say = console.log
window.mmap = {}
window.nmap = {}
window.omap = {}

window.goto = (e)->
  e.scrollIntoView()

run = (m, n, o)->
  $(n).find('h1,h2,h3,h4').each ->
    tag = @.tagName
    text = $(@).text()
      .replace(/^Chapter\s+/, '')
      .replace(/^(\d+\.)+\s+/, '')
    nmap["#{tag} #{text}"] = @

  $(o).find('h1,h2,h3,h4').each ->
    tag = @.tagName
    text = $(@).text()
      .replace(/\s+/g, ' ')
      .replace(/\s$/, '')
      .replace(/^Chapter\s+/, '')
      .replace(/^(\d+\.)+\s+/, '')
    omap["#{tag} #{text}"] = @

  IO = $('iframe')[0].contentWindow.IntersectionObserver

  height = 300 - document.documentElement.scrollHeight

  io = new IO (e)->
    return unless e[0].isIntersecting
    h = $(e[0].target).text()
    h.match /^(#{1,4})\s/ or throw "Bad header #{h}"
    l = RegExp.$1
    l = l.length
    h = h.replace /^#+\s+/, ''
    h = h.replace(/^Chapter\s+/, '')
    h = h.replace(/^(\#\.)+\s+/, '')
    t = "H#{l} #{h}"
    try
      goto nmap[t]
    try
      goto omap[t]
  ,
  rootMargin: "0px 0px #{height}px 0px"
  threshold: [1]

  $(m).find('code').each ->
    io.observe(@)



$(document).ready ->
  window.m = m = (Im = $('iframe')[0]).contentDocument
  window.n = n = (In = $('iframe')[1]).contentDocument
  window.o = o = (Io = $('iframe')[2]).contentDocument
  o = $('iframe')[2].contentDocument
  wait = ->
    say 'wait'
    if m.readyState == 'complete' and
       n.readyState == 'complete' and
       o.readyState == 'complete'
      run m, n, o
    else
      setTimeout wait, 100
  wait()
</script>

</body>

</html>

